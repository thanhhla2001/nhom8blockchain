<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DemoBlockChainProjectTeam8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': '#2563EB', // Blue 600
                        'secondary': '#F59E0B', // Amber 500
                        'valid': '#10B981',
                        'invalid': '#EF4444',
                        'dark': '#1E293B'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .timeline {
            position: relative;
            padding-left: 35px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 5px;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 30px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 6px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            border: 4px solid var(--tw-primary);
            z-index: 10;
        }
    </style>
</head>

<body class="bg-slate-50 font-sans text-slate-800 min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <nav class="bg-dark text-white shadow-md sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
                <div class="bg-primary p-2 rounded-lg shadow-lg"><i class="fa-solid fa-cubes fa-lg"></i></div>
                <span class="font-bold text-xl tracking-wide">DemoBlockChain<span
                        class="text-primary font-extrabold">ProjectTeam8</span></span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="factoryReset()"
                    class="text-xs text-red-400 hover:text-red-300 border border-red-900 bg-red-900/30 px-2 py-1 rounded"
                    title="X√≥a h·∫øt d·ªØ li·ªáu ƒë√£ t·∫°o">
                    <i class="fa-solid fa-trash-can"></i> X√≥a d·ªØ li·ªáu
                </button>
                <button onclick="goHome()"
                    class="text-sm font-medium text-slate-300 hover:text-white transition flex items-center gap-2">
                    <i class="fa-solid fa-house"></i> <span class="hidden sm:inline">Trang ch·ªß</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto w-full p-4 sm:p-6 flex-grow">

        <!-- VIEW 1: HOME & SCAN -->
        <div id="view-home" class="fade-in space-y-8">

            <!-- Header / Scan Section -->
            <div
                class="bg-white rounded-2xl p-8 text-center shadow-lg border border-slate-200 relative overflow-hidden">
                <h2 class="text-3xl font-extrabold text-slate-800 mb-2">Truy Xu·∫•t Ngu·ªìn G·ªëc</h2>
                <p class="text-slate-500 mb-8">Qu√©t m√£ QR ƒë·ªÉ xem nh·∫≠t k√Ω Blockchain ho·∫∑c t·∫°o s·∫£n ph·∫©m m·ªõi ƒë·ªÉ demo.</p>

                <div class="flex flex-col sm:flex-row justify-center gap-4 relative z-10">
                    <!-- N√∫t Qu√©t -->
                    <label for="qr-input"
                        class="cursor-pointer bg-dark hover:bg-slate-800 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-qrcode"></i> Qu√©t / T·∫£i ·∫¢nh QR
                        <input type="file" id="qr-input" accept="image/*" class="hidden"
                            onchange="handleQRUpload(this)">
                    </label>

                    <!-- N√∫t T·∫°o M·ªõi -->
                    <button onclick="openCreateModal()"
                        class="cursor-pointer bg-primary hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus-circle"></i> T·∫°o S·∫£n Ph·∫©m M·ªõi
                    </button>
                </div>

                <div id="scan-loading" class="hidden text-sm text-primary font-medium animate-pulse mt-4">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang ph√¢n t√≠ch ·∫£nh...
                </div>
            </div>

            <!-- Product List -->
            <div>
                <div class="flex items-center justify-between mb-4 border-b pb-2">
                    <h3 class="text-xl font-bold text-slate-700"><i class="fa-solid fa-list"></i> Danh s√°ch s·∫£n ph·∫©m
                        (Demo)</h3>
                    <span
                        class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-bold border border-green-200">
                        <i class="fa-solid fa-database"></i> LocalStorage Active
                    </span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="product-list">
                    <!-- Rendered via JS -->
                </div>
            </div>
        </div>

        <!-- VIEW 2: PRODUCT DETAIL -->
        <div id="view-detail" class="hidden fade-in pb-20">
            <!-- Top Bar Actions -->
            <div
                class="flex flex-wrap justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200 sticky top-20 z-40 gap-2">
                <button onclick="goHome()"
                    class="text-slate-500 hover:text-dark text-sm font-bold flex items-center gap-1">
                    <i class="fa-solid fa-arrow-left"></i> Quay l·∫°i
                </button>
                <div class="flex gap-2">
                    <button onclick="resetData()"
                        class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-xs font-bold border border-slate-300 transition"
                        title="Kh√¥i ph·ª•c d·ªØ li·ªáu h·ª£p l·ªá g·∫ßn nh·∫•t">
                        <i class="fa-solid fa-rotate-right"></i> Reset (Undo Hack)
                    </button>
                    <button onclick="openUpdateModal()"
                        class="bg-primary hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm transition flex items-center gap-1">
                        <i class="fa-solid fa-pen-nib"></i> C·∫≠p nh·∫≠t
                    </button>
                    <button onclick="openHackModal()"
                        class="bg-invalid hover:bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm transition flex items-center gap-1">
                        <i class="fa-solid fa-user-secret"></i> Hack Demo
                    </button>
                </div>
            </div>

            <!-- Status Alert Area -->
            <div id="verification-alert" class="mb-6"></div>

            <!-- Product Content -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Info -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Info Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <div class="border-b border-slate-100 pb-4 mb-4">
                            <h1 class="text-2xl font-extrabold text-slate-800 leading-tight" id="detail-name">Product
                                Name</h1>
                            <p class="text-slate-400 text-sm font-mono mt-1" id="detail-id">#ID</p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <p class="text-xs text-slate-400 uppercase font-bold">L√¥ s·∫£n xu·∫•t</p>
                                <p class="font-semibold text-slate-800 text-lg" id="detail-batch">LOT-001</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase font-bold">Xu·∫•t x·ª©</p>
                                <p class="font-semibold text-primary text-lg" id="detail-origin">Location</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 uppercase font-bold mb-2">Ch·ª©ng nh·∫≠n</p>
                                <div class="flex flex-wrap gap-2" id="detail-certs"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Blockchain Stats -->
                    <div class="bg-slate-50 rounded-2xl border border-slate-200 p-5">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-link text-primary"></i> Blockchain Stats
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-500">T·ªïng s·ªë Block</span>
                                <span class="font-mono font-bold" id="chain-length">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Tr·∫°ng th√°i chu·ªói</span>
                                <span class="font-bold text-valid" id="chain-status">Valid</span>
                            </div>
                            <div>
                                <span class="text-slate-500 block mb-1">Hash m·ªõi nh·∫•t</span>
                                <div class="font-mono text-[10px] bg-white p-2 rounded border border-slate-200 break-all text-slate-600"
                                    id="chain-hash">...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Timeline -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-bold text-xl text-slate-800 mb-6 flex items-center gap-2">
                            <i class="fa-regular fa-clock"></i> Nh·∫≠t k√Ω h√†nh tr√¨nh
                        </h3>
                        <div class="timeline" id="timeline-container">
                            <!-- JS Render -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE PRODUCT MODAL -->
    <div id="create-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-slate-800">üÜï T·∫°o S·∫£n Ph·∫©m M·ªõi</h3>
                <button onclick="closeModals()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark fa-lg"></i></button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">M√£ s·∫£n ph·∫©m (ID)</label>
                    <input type="text" id="create-id" placeholder="VD: PROD-999"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary outline-none uppercase font-mono">
                    <p class="text-xs text-slate-500 mt-1">M√£ n√†y s·∫Ω d√πng ƒë·ªÉ t·∫°o QR Code.</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">T√™n s·∫£n ph·∫©m</label>
                    <input type="text" id="create-name" placeholder="VD: B√°nh P√≠a S√≥c TrƒÉng"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">L√¥ s·∫£n xu·∫•t</label>
                        <input type="text" id="create-batch" placeholder="LOT-NEW-01"
                            class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Xu·∫•t x·ª©</label>
                        <input type="text" id="create-origin" placeholder="ƒê·ªãa ƒëi·ªÉm g·ªëc"
                            class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                    </div>
                </div>
            </div>

            <div class="mt-6 flex gap-3 justify-end">
                <button onclick="closeModals()"
                    class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-xl font-bold text-sm">H·ªßy</button>
                <button onclick="processCreate()"
                    class="px-5 py-2.5 bg-primary hover:bg-blue-700 text-white rounded-xl font-bold text-sm shadow-lg">
                    <i class="fa-solid fa-check"></i> Kh·ªüi t·∫°o Blockchain
                </button>
            </div>
        </div>
    </div>

    <!-- UPDATE STATUS MODAL -->
    <div id="update-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-slate-800 mb-2">üìù C·∫≠p nh·∫≠t tr·∫°ng th√°i</h3>
            <p class="text-sm text-slate-500 mb-4">T·∫°o m·ªôt <strong>Block m·ªõi</strong> n·ªëi v√†o chu·ªói. <br><span
                    class="text-green-600 text-xs font-bold">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn.</span></p>

            <div class="space-y-3">
                <label class="block text-sm font-medium text-slate-700">Tr·∫°ng th√°i m·ªõi</label>
                <select id="new-status-select"
                    class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                    <option value="ƒêang v·∫≠n chuy·ªÉn">üöö ƒêang v·∫≠n chuy·ªÉn</option>
                    <option value="ƒê√£ v·ªÅ kho ph√¢n ph·ªëi">üè≠ ƒê√£ v·ªÅ kho ph√¢n ph·ªëi</option>
                    <option value="ƒêang giao h√†ng">üõµ ƒêang giao h√†ng</option>
                    <option value="ƒê√£ giao th√†nh c√¥ng">‚úÖ ƒê√£ giao th√†nh c√¥ng</option>
                </select>

                <label class="block text-sm font-medium text-slate-700">V·ªã tr√≠ hi·ªán t·∫°i</label>
                <input type="text" id="new-location-input" value="Kho trung chuy·ªÉn Qu·∫≠n 7, TP.HCM"
                    class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
            </div>

            <div class="mt-6 flex gap-3 justify-end">
                <button onclick="closeModals()"
                    class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium text-sm">H·ªßy</button>
                <button onclick="processUpdate()"
                    class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg font-bold text-sm shadow-lg">X√°c
                    nh·∫≠n & L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- HACK SIMULATION MODAL -->
    <div id="hack-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl border-t-4 border-invalid">
            <h3 class="text-lg font-bold text-invalid mb-2"><i class="fa-solid fa-user-secret"></i> Gi·∫£ l·∫≠p T·∫•n c√¥ng
            </h3>
            <p class="text-sm text-slate-500 mb-4">M√¥ ph·ªèng s·ª≠a d·ªØ li·ªáu g·ªëc. Thay ƒë·ªïi n√†y <strong>KH√îNG</strong> ƒë∆∞·ª£c
                l∆∞u v√†o Database (ƒê·ªÉ demo).</p>

            <div class="bg-red-50 p-4 rounded-lg border border-red-100 mb-4">
                <label class="block text-xs font-bold text-red-800 uppercase mb-1">S·ª≠a Xu·∫•t X·ª©</label>
                <input type="text" id="hack-origin-input"
                    class="w-full p-2 border border-red-300 rounded bg-white text-slate-800 focus:outline-none focus:border-invalid font-bold">
                <p class="text-xs text-invalid mt-1 italic">Gi√° tr·ªã c≈©: <span id="hack-origin-old">...</span></p>
            </div>

            <div class="flex gap-3 justify-end">
                <button onclick="closeModals()"
                    class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium text-sm">H·ªßy</button>
                <button onclick="processHack()"
                    class="px-4 py-2 bg-invalid hover:bg-red-700 text-white rounded-lg font-bold text-sm shadow-lg">Th·ª±c
                    hi·ªán</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT (WITH PERSISTENCE) ---
        const DB_KEY = 'blocktrace_db_v1';
        const DEFAULT_DB = [
            {
                id: "PROD-001",
                name: "C√† ph√™ Arabica C·∫ßu ƒê·∫•t",
                batch: "LOT-CF-2401",
                origin: "C·∫ßu ƒê·∫•t, ƒê√† L·∫°t",
                certs: ["VietGAP", "Organic"],
                history: [
                    { date: "15/01/2024", time: "07:30", action: "Thu ho·∫°ch t·∫°i n√¥ng tr·∫°i", location: "N√¥ng tr·∫°i C·∫ßu ƒê·∫•t", handler: "N√¥ng h·ªô A" },
                    { date: "16/01/2024", time: "10:00", action: "S∆° ch·∫ø v√† ƒë√≥ng g√≥i", location: "Nh√† m√°y ch·∫ø bi·∫øn L√¢m ƒê·ªìng", handler: "C√¥ng ty X" }
                ]
            },
            {
                id: "PROD-002",
                name: "Tr√† Oolong B·∫£o L·ªôc",
                batch: "LOT-TEA-2402",
                origin: "B·∫£o L·ªôc, L√¢m ƒê·ªìng",
                certs: ["OCOP 4 Sao"],
                history: [
                    { date: "10/02/2024", time: "06:00", action: "H√°i b√∫p tr√† t∆∞∆°i", location: "ƒê·ªìi tr√† B·∫£o L·ªôc", handler: "N√¥ng h·ªô B" },
                    { date: "11/02/2024", time: "14:00", action: "Sao kh√¥ th√†nh ph·∫©m", location: "X∆∞·ªüng Tr√† Y", handler: "K·ªπ thu·∫≠t vi√™n C" }
                ]
            }
        ];

        let MASTER_DB = [];

        // --- PERSISTENCE FUNCTIONS ---
        function initDB() {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) {
                MASTER_DB = JSON.parse(stored);
            } else {
                MASTER_DB = JSON.parse(JSON.stringify(DEFAULT_DB));
                saveDB();
            }
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(MASTER_DB));
        }

        function factoryReset() {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ t·∫°o v√† quay v·ªÅ m·∫∑c ƒë·ªãnh ban ƒë·∫ßu?")) {
                localStorage.removeItem(DB_KEY);
                initDB();
                renderHomeList();
                alert("ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc c·ªßa h·ªá th·ªëng!");
            }
        }

        let currentProduct = null;
        let traceabilityChain = null;

        // --- BLOCKCHAIN CORE ---
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        class Block {
            constructor(index, timestamp, data, previousHash = '') {
                this.index = index;
                this.timestamp = timestamp;
                this.data = data;
                this.previousHash = previousHash;
                this.hash = '';
            }
            async mine() {
                this.hash = await sha256(this.index + this.previousHash + this.timestamp + JSON.stringify(this.data));
            }
        }

        class Blockchain {
            constructor() {
                this.chain = [];
                this.valid = true;
                this.corruptedBlockIndex = -1;
            }
            async init(historyData) {
                const genesis = new Block(0, Date.now(), { action: "GENESIS BLOCK", location: "System" }, "0");
                await genesis.mine();
                this.chain.push(genesis);

                for (let item of historyData) {
                    await this.addBlock(item);
                }
            }
            async addBlock(data) {
                const prevBlock = this.chain[this.chain.length - 1];
                const newBlock = new Block(this.chain.length, Date.now(), data, prevBlock.hash);
                await newBlock.mine();
                this.chain.push(newBlock);
            }
            async validate() {
                this.valid = true;
                this.corruptedBlockIndex = -1;
                for (let i = 1; i < this.chain.length; i++) {
                    const current = this.chain[i];
                    const previous = this.chain[i - 1];
                    const currentCheckHash = await sha256(current.index + current.previousHash + current.timestamp + JSON.stringify(current.data));
                    if (current.hash !== currentCheckHash) { this.valid = false; this.corruptedBlockIndex = i; return false; }
                    if (current.previousHash !== previous.hash) { this.valid = false; this.corruptedBlockIndex = i; return false; }
                }
                return true;
            }
        }

        // --- NAVIGATION ---
        function goHome() {
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            window.scrollTo(0, 0);
            renderHomeList();
        }

        async function loadProduct(id) {
            // T√¨m trong MASTER_DB (ƒë√£ load t·ª´ storage)
            const rawProduct = MASTER_DB.find(p => p.id === id);
            if (!rawProduct) { alert("S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i!"); return; }

            // Deep Copy ƒë·ªÉ thao t√°c
            currentProduct = JSON.parse(JSON.stringify(rawProduct));

            traceabilityChain = new Blockchain();
            await traceabilityChain.init(currentProduct.history);

            renderDetail();
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        async function resetData() {
            if (!currentProduct) return;
            // Reload t·ª´ MASTER_DB (n∆°i ch·ª©a d·ªØ li·ªáu h·ª£p l·ªá ƒë√£ l∆∞u)
            const original = MASTER_DB.find(p => p.id === currentProduct.id);
            if (original) {
                await loadProduct(original.id);
                alert("ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu h·ª£p l·ªá t·ª´ Database!");
            }
        }

        // --- UI RENDERERS ---
        async function renderDetail() {
            await traceabilityChain.validate();
            const isValid = traceabilityChain.valid;

            document.getElementById('detail-name').textContent = currentProduct.name;
            document.getElementById('detail-id').textContent = "#" + currentProduct.id;
            document.getElementById('detail-batch').textContent = currentProduct.batch;
            document.getElementById('detail-origin').textContent = currentProduct.origin;

            const certContainer = document.getElementById('detail-certs');
            if (currentProduct.certs && currentProduct.certs.length > 0) {
                certContainer.innerHTML = currentProduct.certs.map(c => `<span class="px-2 py-1 bg-green-50 text-green-700 border border-green-200 rounded text-xs font-bold">${c}</span>`).join('');
            } else {
                certContainer.innerHTML = '<span class="text-xs text-slate-400">Ch∆∞a c√≥ ch·ª©ng nh·∫≠n</span>';
            }

            const alertDiv = document.getElementById('verification-alert');
            const statusEl = document.getElementById('chain-status');
            const originEl = document.getElementById('detail-origin');

            if (isValid) {
                alertDiv.innerHTML = `
                    <div class="bg-green-50 border-l-4 border-valid p-4 rounded-r-lg flex items-start gap-3 shadow-sm">
                        <div class="text-valid text-xl"><i class="fa-solid fa-circle-check"></i></div>
                        <div>
                            <h4 class="font-bold text-green-800">X√°c th·ª±c th√†nh c√¥ng</h4>
                            <p class="text-sm text-green-700">D·ªØ li·ªáu s·∫£n ph·∫©m kh·ªõp ho√†n to√†n v·ªõi nh·∫≠t k√Ω Blockchain.</p>
                        </div>
                    </div>`;
                statusEl.textContent = "Valid (H·ª£p l·ªá)";
                statusEl.className = "font-bold text-valid";
                originEl.className = "font-semibold text-primary text-lg";
            } else {
                alertDiv.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-invalid p-4 rounded-r-lg flex items-start gap-3 shadow-sm animate-pulse">
                        <div class="text-invalid text-xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        <div>
                            <h4 class="font-bold text-red-800">C·∫¢NH B√ÅO: D·ªÆ LI·ªÜU B·ªä THAY ƒê·ªîI</h4>
                            <p class="text-sm text-red-700">Ph√°t hi·ªán sai l·ªách t·∫°i <strong>Block #${traceabilityChain.corruptedBlockIndex}</strong>.</p>
                        </div>
                    </div>`;
                statusEl.textContent = "CORRUPTED";
                statusEl.className = "font-bold text-invalid";
                originEl.innerHTML = `${currentProduct.origin} <span class="text-xs bg-red-200 text-red-800 px-1 rounded ml-1">(Fake)</span>`;
                originEl.className = "font-semibold text-invalid text-lg";
            }

            document.getElementById('chain-length').textContent = traceabilityChain.chain.length;
            document.getElementById('chain-hash').textContent = traceabilityChain.chain[traceabilityChain.chain.length - 1].hash;

            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.innerHTML = traceabilityChain.chain.slice(1).map((block, idx) => {
                const isCorrupted = !isValid && (idx + 1) >= traceabilityChain.corruptedBlockIndex;
                const borderColor = isCorrupted ? 'border-invalid bg-red-50' : 'border-slate-200';
                const iconColor = isCorrupted ? 'text-invalid' : 'text-primary';

                return `
                <div class="timeline-item">
                    <div class="ml-8 p-4 bg-white rounded-lg border ${borderColor} shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-slate-800 text-base">${block.data.action}</span>
                            <span class="text-xs text-slate-500 font-mono">${block.data.date} ${block.data.time || ''}</span>
                        </div>
                        <div class="text-sm text-slate-600 mb-2">
                            <i class="fa-solid fa-location-dot w-4 text-center ${iconColor}"></i> ${block.data.location}
                        </div>
                        <div class="text-[10px] font-mono text-slate-400 break-all pt-2 border-t border-slate-100">
                            Hash: ${block.hash}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderHomeList() {
            const container = document.getElementById('product-list');
            container.innerHTML = MASTER_DB.map(p => `
                <div class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition border border-slate-200 flex gap-4 items-center">
                    <div class="w-24 h-24 flex-shrink-0 bg-white rounded-lg p-1 border border-slate-200 flex items-center justify-center">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${p.id}" class="w-full h-full object-contain" alt="QR">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-slate-800 truncate text-lg">${p.name}</h4>
                        <p class="text-xs text-slate-500 font-mono bg-slate-100 inline-block px-1 rounded mb-1">ID: ${p.id}</p>
                        <p class="text-xs text-primary"><i class="fa-solid fa-map-pin"></i> ${p.origin}</p>
                        <p class="text-[10px] text-slate-400 mt-1">Batch: ${p.batch}</p>
                    </div>
                    <button onclick="loadProduct('${p.id}')" class="bg-white text-primary border border-primary hover:bg-primary hover:text-white w-10 h-10 rounded-full flex items-center justify-center transition shadow-sm">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            `).join('');
        }

        // --- MODALS ---
        function closeModals() {
            document.getElementById('update-modal').classList.add('hidden');
            document.getElementById('hack-modal').classList.add('hidden');
            document.getElementById('create-modal').classList.add('hidden');
        }
        function openUpdateModal() { document.getElementById('update-modal').classList.remove('hidden'); }
        function openHackModal() {
            document.getElementById('hack-origin-old').textContent = currentProduct.origin;
            document.getElementById('hack-origin-input').value = currentProduct.origin;
            document.getElementById('hack-modal').classList.remove('hidden');
        }
        function openCreateModal() {
            document.getElementById('create-id').value = '';
            document.getElementById('create-name').value = '';
            document.getElementById('create-batch').value = '';
            document.getElementById('create-origin').value = '';
            document.getElementById('create-modal').classList.remove('hidden');
        }

        // --- ACTIONS ---
        async function processCreate() {
            const id = document.getElementById('create-id').value.trim().toUpperCase();
            const name = document.getElementById('create-name').value.trim();
            const batch = document.getElementById('create-batch').value.trim();
            const origin = document.getElementById('create-origin').value.trim();

            if (!id || !name || !batch || !origin) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!"); return; }
            if (MASTER_DB.find(p => p.id === id)) { alert("M√£ ID n√†y ƒë√£ t·ªìn t·∫°i!"); return; }

            const newProduct = {
                id, name, batch, origin,
                certs: ["New Product"],
                history: [
                    {
                        date: new Date().toLocaleDateString('vi-VN'),
                        time: new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }),
                        action: "Kh·ªüi t·∫°o s·∫£n ph·∫©m",
                        location: origin,
                        handler: "Admin Creator"
                    }
                ]
            };

            MASTER_DB.push(newProduct);
            saveDB(); // L∆ØU V√ÄO LOCALSTORAGE
            closeModals();
            renderHomeList();

            if (confirm("ƒê√£ t·∫°o s·∫£n ph·∫©m th√†nh c√¥ng! B·∫°n c√≥ mu·ªën xem chi ti·∫øt ngay kh√¥ng?")) {
                loadProduct(id);
            }
        }

        async function processUpdate() {
            const status = document.getElementById('new-status-select').value;
            const location = document.getElementById('new-location-input').value;
            const newEvent = {
                date: new Date().toLocaleDateString('vi-VN'),
                time: new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }),
                action: status, location: location, handler: "System Admin"
            };

            // 1. C·∫≠p nh·∫≠t View hi·ªán t·∫°i
            await traceabilityChain.addBlock(newEvent);
            currentProduct.history.push(newEvent);

            // 2. C·∫≠p nh·∫≠t DB t·ªïng v√† L∆ØU L·∫†I
            const dbIndex = MASTER_DB.findIndex(p => p.id === currentProduct.id);
            if (dbIndex !== -1) {
                MASTER_DB[dbIndex] = JSON.parse(JSON.stringify(currentProduct));
                saveDB(); // Persistence
            }

            closeModals();
            renderDetail();
        }

        async function processHack() {
            const newOrigin = document.getElementById('hack-origin-input').value;
            if (newOrigin === currentProduct.origin) { closeModals(); return; }

            // HACK: Ch·ªâ s·ª≠a d·ªØ li·ªáu tr√™n view hi·ªán t·∫°i (RAM), KH√îNG l∆∞u v√†o DB
            // ƒêi·ªÅu n√†y ƒë·ªÉ demo vi·ªác khi t·∫£i l·∫°i trang (Load t·ª´ DB chu·∫©n) th√¨ d·ªØ li·ªáu l·∫°i ƒë√∫ng
            currentProduct.origin = newOrigin;
            if (traceabilityChain.chain.length > 1) {
                traceabilityChain.chain[1].data.location = newOrigin + " (Fake)";
            }

            closeModals();
            renderDetail();
        }

        // --- QR ---
        function handleQRUpload(input) {
            if (input.files && input.files[0]) {
                const loading = document.getElementById('scan-loading');
                loading.classList.remove('hidden');
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width; canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        loading.classList.add('hidden');
                        if (code) {
                            const id = code.data;
                            const prod = MASTER_DB.find(p => p.id === id);
                            if (prod) { loadProduct(id); }
                            else { alert("S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng!"); }
                        } else { alert("Kh√¥ng t√¨m th·∫•y m√£ QR!"); }
                        input.value = '';
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // INIT
        window.onload = () => {
            initDB();
            renderHomeList();
        };
    </script>
</body>

</html>